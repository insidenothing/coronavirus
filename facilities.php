<?PHP
// pull assisted living numbers and store just like side zip_codes 

global $Facility_ZIP;
$Facility_ZIP['Anchorage_Healthcare_Center'] = '21801';
$Facility_ZIP['Arbor_Terrace_Fulton']  = '20759';
$Facility_ZIP['Arden_Courts_of_Pikesville'] = '21208';
$Facility_ZIP['Aspenwood Senior Living Community'] = '20906';
$Facility_ZIP['Atrium Village'] = '21117';
$Facility_ZIP['Autumn Lake Healthcare at Bridgepark'] = '21207';
$Facility_ZIP['Autumn Lake Healthcare at Cherry Lane'] = '20708';
$Facility_ZIP['Autumn Lake Healthcare at Oakview'] = '20910';
$Facility_ZIP['Autumn Lake Healthcare at Riverview'] = '21221';
$Facility_ZIP['Ballenger Creek - Genesis Healthcare'] = '21703';
$Facility_ZIP['Berlin Nursing and Rehabilitation Center'] = '21811';
$Facility_ZIP['Bethesda Health and Rehab'] = '20814';
$Facility_ZIP['Birch Manor Healthcare Center'] = '21784';
$Facility_ZIP['Blue Point Healthcare Center'] = '21215';
$Facility_ZIP['Brighton Gardens at Friendship Heights'] = '20815';
$Facility_ZIP['Brighton Gardens of Columbia'] = '21045';
$Facility_ZIP['Brighton Gardens of Tuckerman Lane'] = '20852';
$Facility_ZIP['Brightview Fallsgrove-Rockville Senior Assisted Living and Memory Care'] = '20850';
$Facility_ZIP['Brinton Woods Health & Rehabilitation Center at Winfield'] = '21784';
$Facility_ZIP['Brookdale of Towson'] = '21212';
$Facility_ZIP['Brookdale Olney'] = '20832';
$Facility_ZIP['Brooke Grove Retirement Community'] = '20860';
$Facility_ZIP['Cadia Healthcare - Hagerstown'] = '21742';
$Facility_ZIP['Cadia Healthcare Wheaton'] = '20902';
$Facility_ZIP['Cadia Hyattsville'] = '20782';
$Facility_ZIP['Charlestown Senior Living Community'] = '21228';
$Facility_ZIP['Charlotte Hall Veterans Home'] = '20622';
$Facility_ZIP['Chesapeake Woods Center'] = '21613';
$Facility_ZIP['Citizens Care and Rehabilitation Center - Frederick'] = '21702';
$Facility_ZIP['Collingswood Rehabilitation and Healthcare Center'] = '20850';
$Facility_ZIP['Copper Ridge'] = '21784';
$Facility_ZIP['Corsica Hills Center'] = '21617';
$Facility_ZIP['Crofton Care and Rehabilitation'] = '21114';
$Facility_ZIP['Cumberland Healthcare Center'] = '21502';
$Facility_ZIP['Doctors Community Rehabilitation and Patient Care Center'] = '20706';
$Facility_ZIP['Edenwald'] = '21286';
$Facility_ZIP['Fayette Health and Rehabilitation Center'] = '21223';
$Facility_ZIP['Fox Chase Rehabilitation & Nursing'] = '20910';
$Facility_ZIP['Frederick Health and Rehabilitation Center'] = '21701';
$Facility_ZIP['Frederick Villa Nursing and Rehabilitation Center'] = '21228';
$Facility_ZIP['Friends House Retirement Community'] = '20860';
$Facility_ZIP['Future Care Irvington'] = '21229';
$Facility_ZIP['FutureCare Canton Harbor'] = '21224';
$Facility_ZIP['FutureCare Courtland'] = '21208';
$Facility_ZIP['FutureCare Homewood'] = '21218';
$Facility_ZIP['FutureCare Sandtown'] = '21217';
$Facility_ZIP['Genesis Catonsville Commons'] = '21228';
$Facility_ZIP['Genesis Cromwell Center'] = '21234';
$Facility_ZIP['Genesis Hammonds Lane'] = '21225';
$Facility_ZIP['Genesis Long Green Center'] = '21212';
$Facility_ZIP['Genesis Severna Park'] = '21146';
$Facility_ZIP['Genesis Waugh Chapel'] = '21054';
$Facility_ZIP['Ginger Cove'] = '21401';
$Facility_ZIP['Glen Burnie Health and Rehabilitation Center'] = '21060';
$Facility_ZIP['Glen Meadows Retirement Community'] = '21057';
$Facility_ZIP['Greater Baltimore Medical Center Sub Acute Unit'] = '21204';
$Facility_ZIP['HeartFields Assisted Living at Frederick'] = '21701';
$Facility_ZIP['HeartLands Senior Living Village at Ellicott City'] = '21043';
$Facility_ZIP['Hebrew Home of Greater Washington'] = '20852';
$Facility_ZIP['Henson Creek Assisted Living'] = '20748';
$Facility_ZIP['Heritage Center Genesis Eldercare'] = '21222';
$Facility_ZIP['Holly Hills Manor'] = '21286';
$Facility_ZIP['Hyattsville Health and Rehab'] = '20783';
$Facility_ZIP['Ingleside at King Farm'] = '20850';
$Facility_ZIP['King David Nursing and Rehabilitation Center'] = '21208';
$Facility_ZIP['Largo Nursing & Rehabilitation Center'] = '20774';
$Facility_ZIP['Layhill Center'] = '20906';
$Facility_ZIP['Levindale Hebrew Geriatric Center and Hospital'] = '21215';
$Facility_ZIP['Little Sisters of the Poor'] = '21228';
$Facility_ZIP['Longview Nursing Home Inc.'] = '21102';
$Facility_ZIP['Lorien Columbia'] = '21044';
$Facility_ZIP['Lorien Mount Airy'] = '21771';
$Facility_ZIP['Lorien Taneytown'] = '21787';
$Facility_ZIP['Manor Care Roland Park'] = '21209';
$Facility_ZIP['Manor Care Wheaton'] = '20902';
$Facility_ZIP['ManorCare Health Services - Ruxton'] = '21204';
$Facility_ZIP['ManorCare Health Services- Rossville'] = '21237';
$Facility_ZIP['ManorCare Health Services- Towson'] = '21286';
$Facility_ZIP['Maria Health Care Center'] = '21212';
$Facility_ZIP['Meadow Park Rehabilitation and Healthcare'] = '21228';
$Facility_ZIP['Montgomery Village Health Care Center'] = '20886';
$Facility_ZIP['Morningside House of Ellicott City'] = '21042';
$Facility_ZIP['North Oak'] = '21208';
$Facility_ZIP['Northwest Health and Rehab Center'] = '21215';
$Facility_ZIP['Nursing and Rehab Center at Stadium Place'] = '21218';
$Facility_ZIP['Oak Crest'] = '21234';
$Facility_ZIP['Orchard Hill Health and Rehab'] = '21204';
$Facility_ZIP['Patapsco Valley Center'] = '21133';
$Facility_ZIP['Peak Health Caton Manor'] = '21229';
$Facility_ZIP['Peake Healthcare at Hartley Hall (Autumn Lake Healthcare at Hartley Hall)'] = '21851';
$Facility_ZIP['Peake Healthcare at the Pines'] = '21601';
$Facility_ZIP['Pleasant View Nursing Home'] = '21771';
$Facility_ZIP['Post Acute Care Center'] = '21206';
$Facility_ZIP['Potomac Valley Rehabilitation and Healthcare Center'] = '20850';
$Facility_ZIP['PowerBack Rehabilitation, Brightwood Campus'] = '21093';
$Facility_ZIP['Regency Care of Silver Spring'] = '20910';
$Facility_ZIP['SagePoint Nursing and Rehabilitation'] = '20646';
$Facility_ZIP['Salisbury Rehabilitation and Nursing Center'] = '21804';
$Facility_ZIP['Seabury at Springvale Terrace'] = '20910';
$Facility_ZIP['Shady Grove Center for Nursing & Rehabilitation'] = '20850';
$Facility_ZIP['Shangri-La Assisted Living'] = '21043';
$Facility_ZIP['Sligo Creek Center - Peak Healthcare'] = '20912';
$Facility_ZIP['Spa Creek Center'] = '21403';
$Facility_ZIP['St. Marys Nursing Center'] = '20650';
$Facility_ZIP['Stella Maris'] = '21093';
$Facility_ZIP['Sterling Care South Mountain'] = '21713';
$Facility_ZIP['Summit Park Health & Rehabilitation Center'] = '21228';
$Facility_ZIP['Sunrise of Columbia'] = '21044';
$Facility_ZIP['Sunrise Senior Living Bethesda'] = '20814';
$Facility_ZIP['The Charleston Senior Community'] = '20603';
$Facility_ZIP['The Neighborhoods at St. Elizabeth Rehabilitation & Nursing Center'] = '21227';
$Facility_ZIP['The Peartree House Assisted Living'] = '21122';
$Facility_ZIP['The Resort at Chester Manor'] = '21620';
$Facility_ZIP['Tribute at Black Hill'] = '20874';
$Facility_ZIP['Tudor Heights Assisted Living'] = '21208';
$Facility_ZIP['Village at Augsburg -- Nursing Home'] = '21207';
$Facility_ZIP['Village at Rockville'] = '20850';
$Facility_ZIP['Westgate Hills Rehabilitation & Healthcare Center'] = '21229';
$Facility_ZIP['Westminster Healthcare Center'] = '21157';

function cleanup($str){
   $str = str_replace("'",'',$str);
   $str = str_replace(".",'',$str);
   $str = str_replace("&",'',$str);
   $str = str_replace("/",'',$str);
   $str = str_replace("(",'',$str);
   $str = str_replace(")",'',$str); 
   $str = str_replace("'",'',$str);
   return $str; 
}


function coronavirus_Facility($Facility_Name,$date,$count){
	global $Facility_ZIP;
	// the order we call the function will matter...
	global $core;
	$q = "select * from coronavirus_facility where Facility_Name = '$Facility_Name' and report_date = '$date'";
	$r = $core->query($q);
	$d = mysqli_fetch_array($r);
	// look for yesterday
	$date2 = date('Y-m-d',strtotime($date)-86400);
	$q2 = "select * from coronavirus_facility where Facility_Name = '$Facility_Name' and report_date = '$date2'";
	$r2 = $core->query($q2);
	$d2 = mysqli_fetch_array($r2);
	if ($d2['id'] != ''){
		// Let's Process Trend Data
		$last_trend_direction = $d2['trend_direction'];
		$last_trend_duration = $d2['trend_duration'];
		$last_report_count = $d2['report_count'];
		if ($count == $last_report_count){
			$current_trend = 'FLAT';	
		}elseif ($count > $last_report_count){
			$current_trend = 'UP';	
		}else{
			$current_trend = 'DOWN';
		}
		if ($last_trend_direction == $current_trend){
			$current_duration = $last_trend_duration + 1;
		}else{
			$current_duration = 0;
		}
	}else{
		// we reached the start of data collection.	
	}
	
	if ($d['id'] == ''){
		$q = "insert into coronavirus_facility (Facility_Name,report_date,report_count,town_name,state_name,trend_direction,trend_duration) values ('$Facility_Name','$date','$count','$town','Maryland','$current_trend','$current_duration') ";
	}else{
		$q = "update coronavirus_facility set report_count = '$count', trend_direction = '$current_trend', trend_duration = '$current_duration'  where Facility_Name = '$Facility_Name' and report_date = '$date' ";
		
	}
	$core->query($q);
	slack_general("$q",'covid19-sql');

}

$r = $core->query("select raw_response from coronavirus_api_cache where api_id = '23' order by id desc");
$d = mysqli_fetch_array($r);
$array = json_decode($json, true);
echo '<pre>';
print_r($array);
echo '</pre>';
foreach ($array['features'] as $key => $value){
	$Facility_Name = $value['attributes']['Facility_Name'];
	$return[$Facility_Name]['Date'] = $value['attributes']['Date'];
	$return[$Facility_Name]['County'] = $value['attributes']['County'];
	$return[$Facility_Name]['Zip'] = $Facility_ZIP[$Facility_Name];
	$return[$Facility_Name]['Number_of_Resident_Cases'] = $value['attributes']['Number_of_Resident_Cases'];
	$return[$Facility_Name]['Number_of_Staff_Cases'] = $value['attributes']['Number_of_Staff_Cases'];
	$return[$Facility_Name]['Number_of_Resident_Deaths'] = $value['attributes']['Number_of_Resident_Deaths'];
	$return[$Facility_Name]['Number_of_Staff_Deaths'] = $value['attributes']['Number_of_Staff_Deaths'];
	$return[$Facility_Name]['Total_Cases'] = $value['attributes']['Total_Cases'];

}



print_r($return);





//coronavirus_Facility($Facility_Name,$date,$count);

?>
